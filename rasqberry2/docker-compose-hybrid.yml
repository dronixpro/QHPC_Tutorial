# Docker Compose - Hybrid Setup for rasqberry (main node)
#
# Control services use bridge network with published ports.
# Compute nodes use host network for MPI compatibility.
#
# Architecture:
#   rasqberry (192.168.4.160):
#     - mysql, slurmdbd, slurmctld (bridge network)
#     - login, c1, c2, q1 (host network for MPI)
#   rasqberry2 (192.168.4.164):
#     - c3, c4, q2 (host network, separate docker-compose)
#
# Node Port Assignments (host networking requires unique ports per slurmd):
#   c1: 6818, c2: 6828, q1: 6838 (on rasqberry)
#   c3: 6818, c4: 6828, q2: 6838 (on rasqberry2)
#
# Usage:
#   cd /home/rasqberry/QCSC/hpc-course-demos/source/rasqberry2
#   docker compose -f docker-compose-hybrid.yml up -d

services:
  mysql:
    image: mariadb:10.11
    hostname: mysql
    container_name: mysql
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_DATABASE: slurm_acct_db
      MYSQL_USER: slurm
      MYSQL_PASSWORD: password
    volumes:
      - var_lib_mysql:/var/lib/mysql
    networks:
      - slurm-control
    restart: unless-stopped

  slurmdbd:
    image: slurm-docker-cluster:25.05.3-dev
    command: ["slurmdbd"]
    container_name: slurmdbd
    hostname: slurmdbd
    volumes:
      - etc_munge:/etc/munge
      - ./etc_slurm:/etc/slurm:ro
      - var_log_slurmdbd:/var/log/slurm
    ports:
      - "6819:6819"
    depends_on:
      - mysql
    networks:
      - slurm-control
    restart: unless-stopped

  slurmctld:
    image: slurm-docker-cluster:25.05.3-dev
    command: ["slurmctld"]
    container_name: slurmctld
    hostname: slurmctld
    volumes:
      - etc_munge:/etc/munge
      - ./etc_slurm:/etc/slurm:ro
      - slurm_jobdir:/data
      - var_lib_slurmd:/var/lib/slurmd
      - var_log_slurmctld:/var/log/slurm
      - ../slurm-docker-cluster/shared:/shared
    ports:
      - "6817:6817"
    depends_on:
      - slurmdbd
    networks:
      - slurm-control
    restart: unless-stopped

  login:
    image: slurm-docker-cluster:25.05.3-dev
    command: ["login"]
    hostname: login
    container_name: login
    stdin_open: true
    tty: true
    # Login uses host network so srun callbacks work
    network_mode: host
    environment:
      - OMPI_MCA_btl_tcp_if_include=wlan0
      - OMPI_MCA_oob_tcp_if_include=wlan0
    extra_hosts:
      - "slurmctld:192.168.4.160"
      - "slurmdbd:192.168.4.160"
      - "mysql:192.168.4.160"
    volumes:
      - etc_munge:/etc/munge
      - ./etc_slurm:/etc/slurm:ro
      - slurm_jobdir:/data
      - ../slurm-docker-cluster/shared:/shared
    depends_on:
      - slurmctld
    restart: unless-stopped

  # Classical compute nodes on rasqberry - use host network for MPI
  # Each uses a different SlurmdPort (configured in slurm.conf)
  c1:
    image: slurm-docker-cluster:25.05.3-dev
    command: ["slurmd", "-N", "c1"]
    hostname: c1
    container_name: c1
    network_mode: host
    environment:
      - OMPI_MCA_btl_tcp_if_include=wlan0
      - OMPI_MCA_oob_tcp_if_include=wlan0
    extra_hosts:
      - "slurmctld:192.168.4.160"
      - "slurmdbd:192.168.4.160"
      - "mysql:192.168.4.160"
    volumes:
      - etc_munge:/etc/munge
      - ./etc_slurm:/etc/slurm:ro
      - slurm_jobdir:/data
      - var_log_c1:/var/log/slurm
      - ../slurm-docker-cluster/shared:/shared
    depends_on:
      - slurmctld
    restart: unless-stopped

  c2:
    image: slurm-docker-cluster:25.05.3-dev
    command: ["slurmd", "-N", "c2"]
    hostname: c2
    container_name: c2
    network_mode: host
    environment:
      - OMPI_MCA_btl_tcp_if_include=wlan0
      - OMPI_MCA_oob_tcp_if_include=wlan0
    extra_hosts:
      - "slurmctld:192.168.4.160"
      - "slurmdbd:192.168.4.160"
      - "mysql:192.168.4.160"
    volumes:
      - etc_munge:/etc/munge
      - ./etc_slurm:/etc/slurm:ro
      - slurm_jobdir:/data
      - var_log_c2:/var/log/slurm
      - ../slurm-docker-cluster/shared:/shared
    depends_on:
      - slurmctld
    restart: unless-stopped

  # Quantum node on rasqberry
  q1:
    image: slurm-docker-cluster:25.05.3-dev
    command: ["slurmd", "-N", "q1"]
    hostname: q1
    container_name: q1
    network_mode: host
    environment:
      - OMPI_MCA_btl_tcp_if_include=wlan0
      - OMPI_MCA_oob_tcp_if_include=wlan0
    extra_hosts:
      - "slurmctld:192.168.4.160"
      - "slurmdbd:192.168.4.160"
      - "mysql:192.168.4.160"
    volumes:
      - etc_munge:/etc/munge
      - ./etc_slurm:/etc/slurm:ro
      - slurm_jobdir:/data
      - var_log_q1:/var/log/slurm
      - ../slurm-docker-cluster/shared:/shared
    depends_on:
      - slurmctld
    restart: unless-stopped

networks:
  slurm-control:
    driver: bridge

volumes:
  etc_munge:
  var_lib_mysql:
  var_lib_slurmd:
  slurm_jobdir:
  var_log_slurmdbd:
  var_log_slurmctld:
  var_log_c1:
  var_log_c2:
  var_log_q1:
